---

- name: run letsencrypt.sh
  command: letsencrypt.sh -c

- name: enable jenkins
  service:
    name: jenkins
    enabled: yes
    state: started

- name: upgrade jenkins
  get_url:
    url: https://updates.jenkins-ci.org/download/war/2.19/jenkins.war
    dest: /usr/local/share/jenkins/jenkins.war
    owner: root
    group: wheel
    mode: 0644
    checksum: sha256:27035f95413f625013b6e7e80b95d6c9b3d0ca084c2bd632f8ecad22229e7453

- name: restore jenkins
  command: "/usr/local/bin/aws s3 sync s3://{{ bucket }} /usr/local/jenkins"
  notify: jenkins permissions

- name: jenkins permissions
  file:
    path: /usr/local/jenkins
    recurse: yes
    owner: jenkins
    group: jenkins

- name: config jenkins
  command: "sysrc jenkins_args='--webroot=/usr/local/jenkins/war --httpPort=8180'"

- name: enable nginx
  service:
    name: nginx
    enabled: yes
    state: started

- name: reload nginx
  service:
    name: nginx
    enabled: yes
    state: reloaded
