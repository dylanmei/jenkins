---

- name: run letsencrypt
  command: letsencrypt.sh -c

- name: set ec2 facts
  action: ec2_facts

- name: mount jenkins file system
  mount:
    fstype: nfs
    name: /usr/local/jenkins
    state: present
    opts: nfsv4
    src: "{{ ansible_ec2_placement_availability_zone}}.{{ jenkins_file_system }}.efs.{{ ansible_ec2_placement_availability_zone[:-1] }}.amazonaws.com:/"

- name: enable jenkins
  service:
    name: jenkins
    enabled: yes
    state: started

- name: upgrade jenkins
  get_url:
    url: https://updates.jenkins-ci.org/download/war/2.21/jenkins.war
    dest: /usr/local/share/jenkins/jenkins.war
    owner: root
    group: wheel
    mode: 0644
    checksum: sha256:ef3693cb5e8c433b9a98b7438c73706b9b41542d781f2ba280cd85ccec307c78

- name: configure jenkins
  command: "sysrc jenkins_args='--webroot=/usr/local/jenkins/war --httpPort=8180'"

- name: enable nginx
  service:
    name: nginx
    enabled: yes
    state: started

- name: reload nginx
  service:
    name: nginx
    enabled: yes
    state: reloaded
